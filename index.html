<!DOCTYPE html>
<html>
<head>
    <title>Live GPS Tracker</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <style>
        html, body, #map { height: 100%; margin: 0; padding: 0; }
        .info-box {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999;
            font-family: sans-serif;
            font-size: 14px;
        }
        #sos-popup {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .popup-window {
            background: rgba(255,255,255,0.95);
            padding: 24px 32px;
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 300px;
            font-family: sans-serif;
        }
        .popup-window h2 {
            color: red;
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .button-row {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .button-row button {
            padding: 10px 16px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }
        #ignore-btn {
            background-color: #ddd;
            color: #222;
        }
        #track-btn {
            background-color: #2196F3;
            color: white;
        }
    </style>
</head>
<script>
  const password = prompt("Enter password:");
  if (password !== "anubhav123") {
    document.body.innerHTML = "<h2>\u274C Access Denied</h2>";
    throw new Error("Access denied");
  }
</script>

<body>
    <div id="map"></div>
    <div class="info-box" id="info"></div>

    <div id="sos-popup">
      <div class="popup-window">
        <h2>Alert! \u26A0\uFE0F</h2>
        <div class="button-row">
          <button id="ignore-btn">Ignore</button>
          <button id="track-btn">Track</button>
        </div>
      </div>
    </div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCQ-l1tIgXkcLVSrwIwO-jG4x2U5ZRvpLQ",
        authDomain: "gps-tracker-537d0.firebaseapp.com",
        databaseURL: "https://gps-tracker-537d0-default-rtdb.firebaseio.com",
        projectId: "gps-tracker-537d0",
        storageBucket: "gps-tracker-537d0.appspot.com",
        messagingSenderId: "806063466436",
        appId: "1:806063466436:web:bfc261355ebacd0e2f2691"
      };

      firebase.initializeApp(firebaseConfig);
      const map = L.map('map').setView([20.59, 78.96], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const infoBox = document.getElementById("info");
      const ref = firebase.database().ref("location");
      const audio = new Audio("/static/alert.mp3");
      audio.loop = true;

      const sosPopup = document.getElementById("sos-popup");
      const ignoreBtn = document.getElementById("ignore-btn");
      const trackBtn = document.getElementById("track-btn");
      let playing = false;

      ref.on("value", (snapshot) => {
        const data = snapshot.val();
        let sosActive = false;
        infoBox.innerHTML = "";

        map.eachLayer((layer) => {
          if (layer instanceof L.Marker) map.removeLayer(layer);
        });

        for (const id in data) {
          const user = data[id];
          const lat = user.lat;
          const lon = user.lon;
          const name = user.name || "Unknown";
          const sos = user.sos || false;

          L.marker([lat, lon])
            .addTo(map)
            .bindPopup(`${name}<br>\ud83d\udccd ${lat}, ${lon}${sos ? "<br>\ud83d\udea8 <b>SOS!</b>" : ""}`);

          infoBox.innerHTML += `<div style="margin-bottom: 8px; ${sos ? 'color:red;' : ''}">
              <b>${name}</b><br>\ud83d\udccd ${lat}, ${lon} ${sos ? '<br>\ud83d\udea8 SOS Triggered!' : ''}
          </div>`;

          if (sos) {
            sosActive = true;
          }
        }

        if (sosActive && !playing) {
          sosPopup.style.display = "flex";
          audio.play();
          playing = true;
        } else if (!sosActive && playing) {
          sosPopup.style.display = "none";
          audio.pause();
          audio.currentTime = 0;
          playing = false;
        }
      });

      ignoreBtn.onclick = () => {
        sosPopup.style.display = "none";
        audio.pause();
        audio.currentTime = 0;
        playing = false;
      };
    </script>
</body>
</html>
